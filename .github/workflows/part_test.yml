# SPDX-License-Identifier: BSD-3-Clause
# SPDX-FileCopyrightText: 2025 Erlang Ecosystem Foundation

on:
  workflow_call: {}

name: "Test"

permissions:
  contents: read

jobs:
  detectToolVersions:
    name: "Detect Tool Versions"

    runs-on: ubuntu-latest

    outputs:
      otpVersion: "${{ steps.toolVersions.outputs.OTP_VERSION }}"
      rebar3Version: "${{ steps.toolVersions.outputs.REBAR3_VERSION }}"

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: "Read .tool-versions"
        id: toolVersions
        run: |
          OTP_VERSION="$(cat .tool-versions | grep erlang | cut -d' ' -f2-)"
          echo OTP: $OTP_VERSION
          echo "OTP_VERSION=${OTP_VERSION}" >> $GITHUB_OUTPUT

          REBAR3_VERSION="$(cat .tool-versions | grep rebar | cut -d' ' -f2-)"
          echo REBAR3: $REBAR3_VERSION
          echo "REBAR3_VERSION=${REBAR3_VERSION}" >> $GITHUB_OUTPUT

  format:
    name: Check Formatting

    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true

      - uses: ./.github/actions/setup-runtime-env

      - run: rebar3 fmt --check

  ct:
    name: rebar3 CT (${{ matrix.name }})

    needs: ["detectToolVersions"]

    runs-on: ${{ matrix.runs-on }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Lowest Supported
          - otp: "27.0"
            name: "lowest"
            runs-on: ubuntu-latest
            unstable: false
          # Latest Supported
          - otp: "${{ needs.detectToolVersions.outputs.otpVersion }}"
            name: "latest"
            runs-on: ubuntu-latest
            unstable: false
          # Test Main
          - otp: "${{ needs.detectToolVersions.outputs.otpVersion }}"
            name: "main"
            runs-on: ubuntu-latest
            unstable: true

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true

      - uses: ./.github/actions/setup-runtime-env
        with:
          otp-version: ${{ matrix.otp }}
          rebar3-version: ${{ needs.detectToolVersions.outputs.rebar3Version }}

      - name: "Run CT Suites"
        run: rebar3 ct --cover
        continue-on-error: ${{ matrix.unstable }}

      - name: "Create HTML Coverage Report"
        run: rebar3 cover

      - name: "Convert Coverage to Cobertura XML"
        run: rebar3 covertool generate

      - name: Send Coverage to Coveralls
        if: always()
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          file: "_build/test/covertool/rebar3_sbom.covertool.xml"
          format: cobertura
          flag-name: ct-${{ matrix.name }}
          parallel: true
      
      - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: coverage-ct-${{ matrix.name }}
          path: "_build/test/cover/*"

  finish_coverage:
    name: Finish Coveralls Report

    needs: ["ct"]

    if: ${{ always() }}

    runs-on: ubuntu-latest

    steps:
    - name: Coveralls Finished
      uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
      with:
        parallel-finished: true
        carryforward: "ct-lowest,ct-latest,ct-main"

  lint:
    name: "Elvis Linter"

    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true

      - uses: ./.github/actions/setup-runtime-env

      - run: rebar3 lint

  dialyzer:
    name: "Check Dialyzer"

    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true

      - uses: ./.github/actions/setup-runtime-env

      - run: rebar3 dialyzer
